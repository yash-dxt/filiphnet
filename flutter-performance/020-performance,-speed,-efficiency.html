<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- People who read source code are awesome.
         Here you are: https://github.com/filiph/filiphnet -->

    <meta charset="utf-8">
    <title>Chapter 2: Performance, speed, efficiency</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="alternate" type="application/atom+xml" title="Filip Hracek’s Flutter Performance Book" href="https://filiph.net/flutter-performance/atom.xml" />

    <meta property="og:title" content="Chapter 2: Performance, speed, efficiency">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://filiph.net/flutter-performance/020-performance,-speed,-efficiency.html">
    <meta property="og:description" content="What's the difference?">
    <meta property="og:image" content="https://filiph.net/img/filiphnet-text.png">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@filiphracek">
    <meta name="twitter:title" content="Chapter 2: Performance, speed, efficiency">
    <meta name="twitter:description" content="What's the difference?">
    <meta name="twitter:image" content="https://filiph.net/img/filiphnet-text.png">

    <meta name="robots" content="all" />
    <meta name="description" content="What's the difference?" />
    <meta name="author" content="Filip Hracek" />

    <style>
      .wrapper {
        max-width: 600px;
        margin: 0 auto;
        padding: 5vw;
      }

      body {
        font-family: Georgia, serif;
      }

      h1, h2 {
        font-family: "Helvetica Neue", Helvetica, sans-serif;
        font-weight: 300;
        text-wrap: balance;
      }

      .above-title {
        font-family: "Helvetica Neue", Helvetica, sans-serif;
        font-size: 0.9rem;
        text-transform: uppercase;
        text-wrap: balance;
      }

      h1 {
        margin-top: 0;
        font-size: 2.6rem;
      }

      h2 {
        font-size: 1.8rem;
        margin-top: 1.6em;
      }

      ul {
        padding-left: 2em;
      }

      p, li {
        font-size: 1.2rem;
        line-height: 1.5em;
      }

      li {
        /*list-style: none;*/
      }

      a, abbr {
        text-decoration: none;
      }

      img, video {
        display: block;
        margin-left: auto;
        margin-right: auto;
        max-width: 100%;
      }

      .signature {
        text-align: right;
      }

      .footer {
        margin-top: 3em;
        border-top: 5px solid gray;
      }

      .filip-portrait {
        margin-top: 1em;
        margin-right: 2em;
        margin-bottom: 1em;
        width: 175px;
        float: left;

        animation: appear-portrait 6s;
      }

      @keyframes appear-portrait { 0% {opacity: 0;} 40% {opacity: 1;} }

      .note {
        text-transform: uppercase;
        font-size: 60%;
        font-family: "Helvetica Neue", Helvetica, sans-serif;
      }

      .highlight {
        background-color: yellow;
      }

      @media screen and (max-width: 380px) {
        .portrait {
          float: none;
          display: block;
          margin: 0 auto;
        }
      }
    </style>

    <script>
      // Docs here: https://docs.mathjax.org/en/latest/options/input/tex.html
      MathJax = {
        tex: {
          inlineMath: [['$', '$']],
          displayMath: [['$$', '$$']]
        },
        svg: {
          fontCache: 'global'
        }
      };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body>
    <div class="wrapper">

      <p class="above-title">
        <a href="/">Filip Hráček</a> /
        <a href="/flutter-performance">Flutter performance</a> /
      </p>

      <h1>Chapter 2: Performance, speed, efficiency</h1>

      <p>I’m intentionally calling this book “Flutter Performance” even though the term is vague. That’s because, if you care about optimizing apps or games, you’re not looking at one neat metric. You have to have a more complex view.</p>
<p>That said, we can build such a view from smaller parts.</p>
<h3 id="efficiency">Efficiency</h3>
<p>Efficiency is the easiest term to define and measure. Given a problem, the more efficient program simply <em>does less work</em>.</p>
<p>Let’s say you want to find the highest number in a list of numbers. That’s the problem. In practical terms, efficiency is how many CPU instructions you need to execute to get the highest number. The fewer instructions you execute, the more efficient your program.</p>
<p>Here’s an example of ARM64 assembly code for finding a maximum value in an array:</p>
<pre><code class="language-asm">findMax:
        sub     sp, sp, #48
        str     x0, [sp, 8]
        str     w1, [sp, 4]
        str     xzr, [sp, 32]
        str     wzr, [sp, 44]
        b       .L2
.L5:
        ldrsw   x0, [sp, 44]
        lsl     x0, x0, 3
        ldr     x1, [sp, 8]
        add     x0, x1, x0
        ldr     d31, [x0]
        str     d31, [sp, 24]
        ldr     d30, [sp, 24]
        ldr     d31, [sp, 32]
        fcmpe   d30, d31
        bgt     .L7
        b       .L3
.L7:
        ldr     d31, [sp, 24]
        str     d31, [sp, 32]
.L3:
        ldr     w0, [sp, 44]
        add     w0, w0, 1
        str     w0, [sp, 44]
.L2:
        ldr     w1, [sp, 44]
        ldr     w0, [sp, 4]
        cmp     w1, w0
        blt     .L5
        ldr     d31, [sp, 32]
        fmov    d0, d31
        add     sp, sp, 48
        ret
</code></pre>
<p>And here’s the same program, but compiled in a higher optimization level. The listing above was compiled with the <code>-O0</code> flag (default mode). The listing below was compiled with the <code>-O3</code> flag (a lot more optimizations enabled).</p>
<pre><code class="language-asm">findMax:
        movi    d0, #0
        cmp     w1, 0
        ble     .L1
        add     x1, x0, w1, uxtw 3
.L3:
        ldr     d31, [x0], 8
        fcmpe   d31, d0
        fcsel   d0, d31, d0, gt
        cmp     x1, x0
        bne     .L3
.L1:
        ret
</code></pre>
<p>Even if you've never seen assembly, you can probably tell that the second listing does less work. There are simply fewer instructions. The unoptimized version does a lot of loading (<code>ldr</code>) and storing (<code>str</code>) into memory, and lacks the obvious optimization of skipping the whole function if the list is empty (<code>cmp w1, 0</code> — is the length zero? <code>ble .L1</code> — if so, jump to the end of the function).</p>
<p>More efficient code does less work, and therefore draws less energy and improves battery life.</p>
<p>It also generally finishes faster. But not always.</p>
<h3 id="speed">Speed</h3>
<p>A program can do less work but still be slower.</p>
<p>One obvious way this happens is when using parallelism. A Dart program can spawn a separate isolate and outsource half of its work to it. By doing so, it will be finished almost twice as fast, but it will also have to spend CPU cycles on managing the extra isolate do it’ll do slightly more work. Slightly lower efficiency, more complex code, but also much faster execution.</p>
<p>Another reason why efficiency and speed sometime don’t go hand in hand is the fact that not all CPU operations take the same amount of time. A CPU loads a number from memory address <code>x0</code> to register <code>d31</code>. (That’s <code>ldr d31, [x0]</code> in ARM assembly.) This operation can take something like 1 nanosecond if the address <code>x0</code> happens to be in Level 1 (L1) cache that sits right next to the CPU. But the same load instruction will take 70-100 nanoseconds if <code>x0</code> is currently not in one of the L1-L3 caches and must be obtained from RAM. (This is why data locality  matters and why we’ll be coming back to this.) So, once again, you can do fewer instructions and therefore have higher efficiency but still be slower.</p>
<p></p>
<img src="Screenshot 2025-01-13 at 15.27.53.png">
<h3 id="jank--smoothness">Jank // Smoothness</h3>
<p>Now, this is where we might stop if we were building mainframe programs. In the old days — like, way before my time even — the most important programs were batch jobs. Think about something like cracking a military code, where you feed a program with the encoded message and some parameters, and you let it run for minutes or even hours. Same with weather forecast or a ballistic research computer, which runs a physics simulation for a long time before spitting out a result.</p>
<p>These programs needed efficiency and speed, of course, especially since hardware was so slow and expensive back then. What they didn't need was nice user experience.</p>
<p>If you were running a weather forecast simulation in the 1960s, you didn't care how usable or unusable the computer got while it was processing — because the simulation was probably the only program running. You just patiently waited.</p>
<p>Today, though, most computing is different. You expect your pocket computer to update a multi-megapixel screen at least 60 times per second while it’s also decoding an animated gif meme on the background. Most computation comes in very short bursts between frames, not in multi-minute batches.</p>
<p>Our tools and our thinking sometime haven’t caught up to this new reality. So many people on the internet stress over the wrong kind of performance. They write and publish benchmarks as if we were all still living in the mainframe days.</p>
<p>Tight loops that run for</p>
<p><span class="highlight">TODO: finish chapter</span></p>


      <p class="signature">
        <a href="/flutter-performance/#chapters">(back to index)</a>
      </p>

      <div class="footer">
        <img class="filip-portrait" width="175" height="233" src="/img/filip.jpg" srcset="/img/filip.jpg 1x, /img/filip@2x.jpg 2x, /img/filip@3x.jpg 3x, /img/filip@4x.jpg 4x" alt="Filip Hracek’s face">
<p><a href="https://filiph.net/">Filip</a> worked at Google for 14 years — the last 6 on the Dart and Flutter teams in Mountain View. You may recognize him from some of the educational content from that time. Now he’s based in Prague as an open-source contractor and game developer. He writes Dart code every day.</p>
<p>The text you just read is supposed to be a chapter in Filip’s planned <a href="/flutter-performance/">book about Dart and Flutter performance</a>.
<a href="/await">Get notified</a> when he’s finished.</p>
<!--
His main project these days is
[GIANT ROBOT GAME](https://store.steampowered.com/app/2538440/GIANT_ROBOT_GAME/)
(Steam link).
-->


        <p><small><a href="https://filiph.net/flutter-performance/atom.xml">RSS</a></small></p>
      </div>
    </div>
  </body>
</html>
